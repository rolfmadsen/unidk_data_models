name: Generate PlantUML Diagram

permissions:
  contents: write

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BASEROW_TOKEN: ${{ secrets.BASEROW_TOKEN }}
      BASE_URL: https://api.baserow.io
      TABLE_ID: 495798

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Build diagram.puml
        run: |
          echo "@startuml" > diagram.puml
          curl -s -H "Authorization: Token $BASEROW_TOKEN" \
            "$BASE_URL/api/database/rows/table/$TABLE_ID/?user_field_names=true" \
            | jq -r '.results[]
                      | select(.Klasse != null and .Klasse != "")
                      | "class \(.Klasse) {}"' \
            >> diagram.puml
          echo "@enduml" >> diagram.puml
          ls -1 diagram.puml

      - name: Render diagram.svg via Docker
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}":/workspace -w /workspace \
            plantuml/plantuml:latest \
            -tsvg diagram.puml
          ls -1 diagram.svg

      - name: Commit PUML & SVG
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update UML diagram"
          file_pattern: |
            diagram.puml
            diagram.svg
